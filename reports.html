<!DOCTYPE html>
<html>
<head>
  <title>Inventory Reports</title>
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <style>
    /* Additional styles for reports */
    .reports-container {
        padding: 20px;
    }
    
    .reports-header {
        margin-bottom: 30px;
    }
    
    .reports-header h2 {
        margin: 0;
        font-size: 24px;
        color: #333;
    }
    
    .reports-header p {
        color: #666;
        margin-top: 5px;
    }
    
    .reports-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .reports-table {
        margin-top: 20px;
    }
    
    .table-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-view {
        background-color: #3498db;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-view:hover {
        background-color: #2980b9;
    }
    
    .btn-download {
        background-color: #2ecc71;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-download:hover {
        background-color: #27ae60;
    }
    
    .btn-delete {
        background-color: #e74c3c;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-delete:hover {
        background-color: #c0392b;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 10px;
        color: #bdc3c7;
    }
    
    /* Modal for report generation */
    .report-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .report-modal-content {
        background: white;
        border-radius: 8px;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .report-modal h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
    }
    
    .report-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .hidden {
        display: none !important;
    }
  </style>
</head>

<body>
  <div id="sidebar"></div>
  <div id="topbar"></div>

  <div class="content">
    <div class="reports-container">
        <!-- Header -->
        <div class="reports-header">
            <h2>Inventory Reports</h2>
            <p>Generate, view, and download inventory reports</p>
        </div>

        <!-- Action Buttons -->
        <div class="reports-actions">
            <button id="generate-report-btn" class="btn">Generate New Report</button>
            <button id="generate-monthly-btn" class="btn-secondary">Generate Monthly Report</button>
            <button id="export-csv-btn" class="btn">Export Inventory (CSV)</button>
        </div>

        <!-- Loading State -->
        <div id="loading-reports" class="loading hidden">
            <div class="spinner"></div>
            <p>Loading reports...</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden" style="background: #fee; color: #c00; padding: 15px; border-radius: 5px; margin-bottom: 15px;"></div>

        <!-- Reports Table -->
        <div class="reports-table">
            <table id="reports-table" class="table hidden">
                <thead>
                    <tr>
                        <th>Report Date</th>
                        <th>Generated</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-list">
                    <!-- Reports will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="empty-reports" class="empty-state">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
            <h3>No Reports Yet</h3>
            <p>Generate your first inventory report to get started</p>
        </div>
    </div>
  </div>

  <!-- Generate Report Modal -->
  <div id="report-modal" class="report-modal hidden">
    <div class="report-modal-content">
        <h3>Generate New Report</h3>
        <p>Create an inventory report for a specific date.</p>
        
        <div style="margin: 20px 0;">
            <label for="report-date" style="display: block; margin-bottom: 8px; font-weight: bold;">Report Date</label>
            <input type="date" id="report-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="background: #e8f4fc; padding: 12px; border-radius: 4px; margin-bottom: 20px;">
            <strong>Note:</strong> Monthly reports are automatically generated on the 1st of each month.
        </div>
        
        <div class="report-modal-actions">
            <button id="cancel-report-btn" class="btn-secondary">Cancel</button>
            <button id="confirm-generate-btn" class="btn">Generate Report</button>
        </div>
    </div>
  </div>

  <!-- Your existing scripts -->
  <script src="js/ui.js"></script>
  <script src="js/api.js"></script>
  
  <!-- Reports JavaScript -->
  <script>
    // DOM Elements
    let currentReports = [];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Reports page loaded');
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('report-date').value = today;
        
        // Load reports
        loadReports();
        
        // Setup button event listeners
        setupEventListeners();
    });

    function setupEventListeners() {
        // Generate New Report button
        document.getElementById('generate-report-btn').addEventListener('click', openGenerateModal);
        
        // Generate Monthly Report button
        document.getElementById('generate-monthly-btn').addEventListener('click', generateMonthlyReport);
        
        // Export CSV button
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        
        // Modal buttons
        document.getElementById('cancel-report-btn').addEventListener('click', closeGenerateModal);
        document.getElementById('confirm-generate-btn').addEventListener('click', generateReport);
        
        // Close modal when clicking outside
        document.getElementById('report-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeGenerateModal();
            }
        });
    }

    function showLoading(show) {
        const loading = document.getElementById('loading-reports');
        const table = document.getElementById('reports-table');
        const empty = document.getElementById('empty-reports');
        const error = document.getElementById('error-message');
        
        if (show) {
            loading.classList.remove('hidden');
            table.classList.add('hidden');
            empty.classList.add('hidden');
            error.classList.add('hidden');
        } else {
            loading.classList.add('hidden');
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        document.getElementById('empty-reports').classList.add('hidden');
        document.getElementById('reports-table').classList.add('hidden');
    }

    async function loadReports() {
        console.log('Loading reports...');
        showLoading(true);
        
        try {
            // Use your existing api.js function or fetch directly
            let data;
            if (typeof apiGet === 'function') {
                // If you have api.js with apiGet function
                data = await apiGet('/reports/list');
            } else {
                // Fallback to fetch
                const response = await fetch('/reports/list');
                data = await response.json();
            }
            
            console.log('Reports data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load reports');
            }
            
            currentReports = data.reports || [];
            displayReports(currentReports);
            
        } catch (error) {
            console.error('Error loading reports:', error);
            showError('Error loading reports: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function displayReports(reports) {
        const table = document.getElementById('reports-table');
        const container = document.getElementById('reports-list');
        const emptyState = document.getElementById('empty-reports');
        
        container.innerHTML = '';
        
        if (!reports || reports.length === 0) {
            table.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        table.classList.remove('hidden');
        emptyState.classList.add('hidden');
        
        reports.forEach(report => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${report.report_date || 'N/A'}</td>
                <td>${report.created}</td>
                <td>${report.size}</td>
                <td>
                    <div class="table-actions">
                        <button class="btn-view" onclick="viewReport('${report.filename}')">View</button>
                        <button class="btn-download" onclick="downloadReport('${report.filename}')">Download</button>
                        <button class="btn-delete" onclick="deleteReport('${report.filename}')">Delete</button>
                    </div>
                </td>
            `;
            container.appendChild(row);
        });
    }

    function openGenerateModal() {
        document.getElementById('report-modal').classList.remove('hidden');
    }

    function closeGenerateModal() {
        document.getElementById('report-modal').classList.add('hidden');
    }

    async function generateReport() {
        const dateInput = document.getElementById('report-date').value;
        const generateBtn = document.getElementById('confirm-generate-btn');
        const originalText = generateBtn.textContent;
        
        if (!dateInput) {
            alert('Please select a date');
            return;
        }
        
        try {
            // Show loading on button
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            console.log('Generating report for date:', dateInput);
            
            let result;
            if (typeof apiPost === 'function') {
                // Use your existing api.js
                result = await apiPost('/reports/generate', { date: dateInput });
            } else {
                // Fallback to fetch
                const response = await fetch('/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date: dateInput })
                });
                result = await response.json();
            }
            
            console.log('Generate response:', result);
            
            if (result.success) {
                alert('‚úÖ Report generated successfully!\n\nFilename: ' + result.report.filename + '\nDate: ' + result.report.date);
                closeGenerateModal();
                loadReports(); // Refresh the list
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (error) {
            console.error('Generate report error:', error);
            alert('‚ùå Network error: ' + error.message);
        } finally {
            // Reset button
            generateBtn.textContent = originalText;
            generateBtn.disabled = false;
        }
    }

    async function generateMonthlyReport() {
        if (!confirm('Generate a monthly report for the 1st of this month?')) {
            return;
        }
        
        try {
            showLoading(true);
            
            let result;
            if (typeof apiPost === 'function') {
                result = await apiPost('/reports/generate/monthly', {});
            } else {
                const response = await fetch('/reports/generate/monthly', {
                    method: 'POST'
                });
                result = await response.json();
            }
            
            if (result.success) {
                alert('‚úÖ Monthly report generation started. Check back in a moment.');
                // Refresh after 2 seconds
                setTimeout(loadReports, 2000);
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (error) {
            alert('‚ùå Network error: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function exportToCSV() {
        try {
            showLoading(true);
            
            let data;
            if (typeof apiGet === 'function') {
                data = await apiGet('/reports/inventory');
            } else {
                const response = await fetch('/reports/inventory');
                data = await response.json();
            }
            
            if (!data.success) {
                throw new Error(data.error);
            }
            
            // Convert to CSV
            const headers = ['Product Name', 'Quantity', 'Category', 'Threshold', 'Unit Price', 'Total Value'];
            const rows = data.data.map(item => [
                `"${item.name.replace(/"/g, '""')}"`,
                item.qty,
                `"${item.category.replace(/"/g, '""')}"`,
                item.threshold,
                item.unit_price,
                item.total_value
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Inventory exported to CSV successfully!');
            
        } catch (error) {
            alert('‚ùå Error exporting to CSV: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function viewReport(filename) {
        const url = `/reports/download/${filename}`;
        window.open(url, '_blank');
    }

    function downloadReport(filename) {
        const url = `/reports/download/${filename}?download=true`;
        window.location.href = url;
    }

    async function deleteReport(filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
            return;
        }
        
        try {
            let result;
            if (typeof apiDelete === 'function') {
                result = await apiDelete(`/reports/delete/${filename}`);
            } else {
                const response = await fetch(`/reports/delete/${filename}`, {
                    method: 'DELETE'
                });
                result = await response.json();
            }
            
            if (result.success) {
                alert('‚úÖ Report deleted successfully');
                loadReports();
            } else {
                alert('‚ùå Error: ' + result.error);
            }
        } catch (error) {
            alert('‚ùå Network error: ' + error.message);
        }
    }
  </script>
</body>
</html>